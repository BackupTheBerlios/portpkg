#!/bin/sh -u
# admin.merge -- merge ports from open/ to another group
#                FOR PORTPKG ADMINISTRATION ONLY

. `which portpkg` || exit 1

HELP="Usage: `basename $0` <port> <new_group>
  Merges \`port' from open/ (if not specified) to \`new_group/.'"

[ "$1" ] || die "$HELP"
case $1 in
  */*) get_info $1 || die;;
  *)   get_info open/$1 || die;;
esac

# look if we have an info file
if [ -f $path/info ]; then
  new_group=`grep -i "^Intended group:" $path/info | cut -d " " -f 3- | xargs | sed "s,\.$,,;s,/$,,"`
  msg=`grep -i "^Changelog entry:" $path/info | cut -d " " -f 3- | sed "s,^ ,,;s,  *, ,g"`
fi

[ "$2" ] && new_group=`echo $2 | cut -d / -f 1`
[ "$new_group" ] || die "$HELP"
tag=`echo $package | egrep -o "[a-z]+$"`
[ "$msg" ] && msg="$msg ($tag)" || msg="Moved $group/$package to $new_group/."

echo -n "Merging $group/$name to $new_group/
ChangeLog entry: "$msg"

* Continue? (ctrl-c to cancel) "
read

# first clean new_group/
if [ -d $PRT_DIR/$new_group/$name ]; then
  stanza "Cleaning $new_group/$name..."
  find $PRT_DIR/$new_group/$name -type f ! -path "*CVS*" -exec rm -rf {} \;
fi

# copy files
stanza "Copying files..."
rm -rf $path/info
cd `dirname $path`
find $name/ ! -path "*CVS*" -exec cp -vP --parents {} $PRT_DIR/$new_group/ \;
#sleep 1
#touch $PRT_DIR/$new_group/$name/footprint

# export new_group/name
cd $PRT_DIR/$new_group/$name
portpkg -mx "$msg" || die #$new_group/$name || die

# remove old entry
stanza "Removing $group/$name..."
cd `dirname $path`
cvs rm -f $name && cvs ci -m "$msg" $name && rm -rf $path
