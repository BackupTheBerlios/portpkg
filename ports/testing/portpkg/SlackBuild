CWD=`pwd`
NAME=`basename $CWD`
TMP=${TMP:-/tmp}
PKG=$TMP/package-$NAME
rm -rf $PKG

VERSION=0.38test18
ARCH=noarch
BUILD=1tom

SYSCONFDIR=etc/portpkg
BINDIR=usr/bin
MANDIR=usr/man
LOCALSTATEDIR=var/log

# configuration
mkdir -p $PKG/$SYSCONFDIR/plugins
mkdir -p $PKG/$SYSCONFDIR/virtual
install -m 644 $CWD/mirrors $PKG/$SYSCONFDIR/
install -m 644 $CWD/ignore $PKG/$SYSCONFDIR/
install -m 644 $CWD/exclude $PKG/$SYSCONFDIR/
install -m 644 $CWD/use $PKG/$SYSCONFDIR/
#install -m 644 $CWD/translate $PKG/$SYSCONFDIR/
install -m 644 $CWD/export.* $PKG/$SYSCONFDIR/plugins/
install -m 644 $CWD/sync.* $PKG/$SYSCONFDIR/plugins/

# virtual groups
for i in $CWD/group.*; do
  install -m 644 $i $PKG/$SYSCONFDIR/virtual/${i#*group.}
done

# generate default local.conf
{ echo -e "This is the complete list of default values:\n"
  sed -n "/^[A-Z0-9_]*=\${[A-Z0-9_]*:-.*}$/p" $CWD/portpkg
} | sed "s,=\${.*:-,=,;s,}$,,;s,..*,#&," \
>$PKG/$SYSCONFDIR/local.conf

# rename anything to .new
for i in `find $PKG/$SYSCONFDIR/ -type f`; do
  mv $i $i.new
done

# man page
mkdir -p $PKG/$MANDIR/man1
install -m 644 $CWD/portpkg.1 $PKG/$MANDIR/man1/
gzip -9 $PKG/$MANDIR/man?/*

# executables
mkdir -p $PKG/$BINDIR
install -m 755 $CWD/portpkg $PKG/$BINDIR/
sed -i -r "s,^(ENGINE_VER=).*$,\1$VERSION," $PKG/$BINDIR/portpkg
install -m 755 $CWD/pp-config $PKG/$BINDIR/
install -m 755 $CWD/checkpkg $PKG/$BINDIR/
install -m 755 $CWD/autoport $PKG/$BINDIR/
chown -R root.bin $PKG/$BINDIR

# integrate pp-config into pkgtool
mkdir -p $PKG/$LOCALSTATEDIR/setup
ln -s /$BINDIR/pp-config $PKG/$LOCALSTATEDIR/setup/setup.portpkg

# documentation
mkdir -p $PKG/usr/doc/$NAME-$VERSION
cp -a \
  ABOUT COPYING CREDITS FAQ NEWS README* ROADMAP \
  $PKG/usr/doc/$NAME-$VERSION/
mkdir -p $PKG/install
cat $CWD/slack-desc | sed "s,XXX,$VERSION,g" >$PKG/install/slack-desc
cat $CWD/doinst.sh >$PKG/install/doinst.sh

cd $PKG
makepkg -p -l y -c n $TMP/$NAME-$VERSION-$ARCH-$BUILD.tgz
