#!/bin/sh -u
# admin.changelogs -- update ChangeLog and recent changes/complete list
#                     FOR PORTPKG ADMINISTRATION ONLY

. `which portpkg` || exit 1

pp_home=/home/groups/portpkg/htdocs
t=`mktemp`

stanza "Updating ChangeLogs:"

has_prog cvs2cl.pl || die
is_defined MY_CVSTAG || die
cd $PRT_DIR/ || die

row "Examining CVS history"
cvs2cl.pl -g -qz9 -I ChangeLog
rm -f ChangeLog.bak

row "Committing ChangeLog"
cvs -qz9 ci -m "Updated." ChangeLog

# httpup support is broken now :-(
## create httpup-repo
#cd $ports
#httpup-repgen2 .
#sed -i "/CVS/d" REPO

# create recent changes and amount of ports
row "Generating recent changes list"
ARCH=i486
t=`mktemp -d`
find $PRT_DIR/ -name Entries -exec grep -H "^/" {} \; \
| grep SlackBuild | wc -l >$t/amount
last_date=""
echo "<dl>" >$t/recent
find $PRT_DIR/ -name Entries -exec grep -H "^/" {} \; \
| grep SlackBuild | sort -k 5r -k 2Mr -k 3r -k 4r 2>/dev/null | head -n 20 \
| while read s; do
  date=`echo $s | rev | cut -d / -f 3 | cut -d \  -f 1,3,4 | rev`
  [ "$date" != "$last_date" ] && echo "<dt>$date</dt>"
  port=`echo $s | rev | cut -d / -f 5,8- | rev`
  gname=`echo $port | scr2gname`
  rel=`echo $port | scr2virt | any2gpkg | pkg2rel`
  echo "<a href=http://cvs.berlios.de/cgi-bin/viewcvs.cgi/portpkg/ports/$gname>$gname</a> $rel<br>"
  last_date=$date
done >>$t/recent
echo "</dl>" >>$t/recent

# generate complete list
row "Generating complete list"
#echo "<link rel=\"stylesheet\" type=\"text/css\" href=\"style.css\">" >$t/complete
last_group=""
find $PRT_DIR/ -name Entries -exec grep -H "^/" {} \; | grep SlackBuild \
| rev | cut -d / -f 5,8- | rev | scr2virt \
| grep -ve [0-9]$ -e ^$PRT_DIR/local/ | sort | while read s; do
  g=`echo $s | any2gpkg | cut -d / -f 1`
  p=`echo $s | any2gpkg | cut -d / -f 2`
  n=`echo $p | pkg2name`
  r=`echo $p | pkg2rel`
  d=`grep -s ^$n: $(dirname $s)/$n/slack-desc | head -n 1 | cut -d " " -f 2-`
  [ "$last_group" != "$g" ] && echo "Group $g/"
#  [ "$last_group" != "$g" ] && echo "<dt>Group $g/</dt>"
  echo "  $p % $d"
#  echo "<a href=http://cvs.berlios.de/cgi-bin/viewcvs.cgi/portpkg/ports/$g/$n>$g/$n</a> $r<br>"
  last_group=$g
done | column -t -s % >$t/complete
#done >>$t/complete

row "Submitting to http://portpkg.berlios.de"
scp $t/amount $MY_CVSTAG@shell.berlios.de:$pp_home/ports.amount #>$output
scp $t/recent $MY_CVSTAG@shell.berlios.de:$pp_home/ports.recent #>$output
scp $t/complete $MY_CVSTAG@shell.berlios.de:$pp_home/ports.complete #>$output
