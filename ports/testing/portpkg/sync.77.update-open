#BLURB="Merge HTTP submitted ports to CVS (developers only)"

# check that we're a plug-in
if [ "`basename $0`" != "portpkg" ]; then
  echo "Don't run me directly!"
  exit 1
fi

is_defined MY_CVSTAG || die

# portpkg's home directory on the server
pp_home=/home/groups/portpkg/htdocs
upload_root=http://portpkg.berlios.de/upload

row "Syncing $PRT_DIR/open/ with $upload_root"

has_prog lynx || die

# check out new ports
new_ports=`lynx -dump $upload_root | sed "0,/^Refer/d"| grep -o "http://.*-.*-.*-.*\.tar\.bz2$"`

$VERBOSE && local output=/dev/stdout || local output=/dev/null

# quit if there are none
if [ "$new_ports" ]; then
  for src in $new_ports; do
    pkg=`basename $src`
    row "Downloading `basename $src` from `echo $src | cut -d / -f 3`"
    wget -O $PRT_DIR/open/$pkg $src 2>$output || continue
  
    row "Mergeing $pkg"
    name=`basename $pkg .tar.bz2 | pkg2name`
    if [ "`tar tjf $PRT_DIR/open/$pkg | sed "1d;s,\./,," | cut -d / -f 1 | sort -u`" != "$name" ]; then
      row "Skipping: $pkg has illegal prefix!"
      continue
    fi
  
    # clean port dir and extract tarball
    find $PRT_DIR/open/$name/ -type f ! -path "*CVS*" -exec rm -v {} \; 2>/dev/null
    tar xjvf $PRT_DIR/open/$pkg --exclude "*CVS*" -C $PRT_DIR/open/
    rm $PRT_DIR/open/$pkg
  
    # remove SlackBuilds that are not in ./*/*SlackBuild
    find $PRT_DIR/open/$name/ -name "*SlackBuild" -mindepth 2 -exec mv {} {}.renamed \;
    find $PRT_DIR/open/$name/ -type f -exec chmod 644 {} \;
    find $PRT_DIR/open/$name/ -type d -exec chmod 755 {} \;
    find $PRT_DIR/open/$name/ -name ".*" -exec rm -v {} \;
  
    # commit
    msg=`grep -si "^ChangeLog" $PRT_DIR/open/$name/info | cut -d : -f 2 | xargs`
    tag=`basename ${pkg##*[0-9-][0-9]} .tar.bz2`
    get_info open/$name
#    portpkg -mx "$msg ($tag)" open/$name
    maintain=true
    # this must be done with the CVS exporter plugins
    head -n 1 $CFG_DIR/export | grep -sq CVS || die "You must use export.cvs here!"
    do_export "$msg ($tag)" open/$name

    # move it (maybe not first post today?)
    row "Moving into merged/"
    ssh $MY_CVSTAG@shell.berlios.de "mv -f $pp_home/upload/$pkg $pp_home/upload/merged/"
  done
fi
