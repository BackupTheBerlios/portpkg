#BLURB="HTTP-submitted ports (developers only)"

# check that we're a plug-in
if [ "`basename $0`" != "portpkg" ]; then
  echo "Don't run me directly!"
  exit 1
fi

is_defined MY_CVSTAG || die

# portpkg's home directory on the server
pp_home=/home/groups/portpkg/htdocs
upload_root=http://portpkg.berlios.de/upload

# check out new ports
row "Syncing $PRT_DIR/open/ with $upload_root"
new_ports=`lynx -dump $upload_root | sed "0,/^Refer/d"| grep -o "http://.*-.*-.*-.*\.tar\.bz2$"`

$VERBOSE && local output=/dev/stdout || local output=/dev/null

# quit if there are none
if [ "$new_ports" ]; then
  for src in $new_ports; do
    pkg=`basename $src`
    row "Downloading `basename $src` from `echo $src | cut -d / -f 3`"
    wget -O $PRT_DIR/open/$pkg $src 2>$output || continue
  
    row "Mergeing $pkg"
    name=`basename $pkg .tar.bz2 | pkg2name`
    if [ "`tar tjf $PRT_DIR/open/$pkg | sed "1d;s,\./,," | cut -d / -f 1 | sort -u`" != "$name" ]; then
      row "Skipping: $pkg has illegal prefix!"
      continue
    fi
  
    # clean port dir and extract tarball
    find $PRT_DIR/open/$name/ -type f ! -path "*CVS*" -exec rm -v {} \;
    tar xjvf $PRT_DIR/open/$pkg --exclude "*CVS*" -C $PRT_DIR/open/
    rm $PRT_DIR/open/$pkg
  
    # remove SlackBuilds that are not in ./*/*SlackBuild
    find $PRT_DIR/open/$name/ -name "*SlackBuild" -mindepth 2 -exec mv {} {}.renamed \;
    find $PRT_DIR/open/$name/ -type f -exec chmod 644 {} \;
    find $PRT_DIR/open/$name/ -type d -exec chmod 755 {} \;
    find $PRT_DIR/open/$name/ -name ".*" -exec rm -v {} \;
  
    # commit
    msg=`grep -si "^ChangeLog" $PRT_DIR/open/$name/info | cut -d : -f 2 | xargs`
    tag=`basename ${pkg##*[0-9-][0-9]} .tar.bz2`
    portpkg -mx "$msg ($tag)" open/$name

    # move it (maybe not first post today?)
    row "Moving into merged/"
    ssh $MY_CVSTAG@shell.berlios.de "mv -f $pp_home/upload/$pkg $pp_home/upload/merged/"
  done
fi

# httpup support is broken now :-(
## create httpup-repo
#cd $ports
#httpup-repgen2 .
#sed -i "/CVS/d" REPO

# create recent changes and amount of ports
row "Generating recent changes list"
ARCH=i486
t=`mktemp -d`
find $PRT_DIR/ -name Entries -exec grep -H "^/" {} \; \
| grep SlackBuild | wc -l >$t/amount
last_date=""
find $PRT_DIR/ -name Entries -exec grep -H "^/" {} \; \
| grep SlackBuild | sort -k 5r -k 2Mr -k 3r -k 4r 2>/dev/null | head -n 20 \
| while read s; do
  date=`echo $s | rev | cut -d / -f 3 | cut -d \  -f 1,3,4 | rev`
  [ "$date" != "$last_date" ] && echo "<i>$date</i><br>"
  port=`echo $s | rev | cut -d / -f 5,8- | rev`
  gname=`echo $port | scr2gname`
  rel=`echo $port | scr2virt | any2gpkg | pkg2rel`
  echo "<a href=http://cvs.berlios.de/cgi-bin/viewcvs.cgi/portpkg/ports/$gname>$gname</a>-$rel<br>"
  last_date=$date
done >$t/recent

# generate complete list
last_group=""
find $PRT_DIR/ -name Entries -exec grep -H "^/" {} \; | grep SlackBuild \
| rev | cut -d / -f 5,8- | rev | scr2virt \
| grep -ve [0-9]$ -e ^$PRT_DIR/local/ | sort | while read s; do
  g=`echo $s | any2gpkg | cut -d / -f 1`
  p=`echo $s | any2gpkg | cut -d / -f 2`
  n=`echo $p | pkg2name`
  d=`grep ^$n: $(dirname $s)/$n/slack-desc | head -n 1 | cut -d " " -f 2-`
  [ "$last_group" != "$g" ] && stanza "Group $g/"
  echo "  $p % $d"
  last_group=$g
done | column -t -s % >$t/complete

scp $t/amount $MY_CVSTAG@shell.berlios.de:$pp_home/ports.amount >$output
scp $t/recent $MY_CVSTAG@shell.berlios.de:$pp_home/ports.recent >$output
scp $t/complete $MY_CVSTAG@shell.berlios.de:$pp_home/ports.complete >$output

## if we have an argument, we do the long walk
[ "$@" ] || exit 0

# make ChangeLogs
#row "Update ChangeLogs"
t=`mktemp`
for i in . d/portpkg; do
  cd $PRT_DIR/$i
  has_prog cvs2cl.pl || continue
  cvs2cl.pl -g -qz9 -f $t -I ChangeLog
  if ! cmp -s $t ChangeLog; then
    row "Updating $i/ChangeLog"
    cat $t >ChangeLog
    cvs -qz9 ci -m "Updated." ChangeLog
  fi
done
