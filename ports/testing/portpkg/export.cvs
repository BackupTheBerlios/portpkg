#BLURB="Export to Portpkg via CVS (developers only)"

# check that we're a plug-in
if [ "`basename $0`" != "portpkg" ]; then
  echo "Don't run me directly!"
  exit 1
fi

is_defined MY_CVSTAG || die

t=`mktemp -d`
export CVS_RSH=ssh

row "Submitting $group/$package via CVS"

has_prog cvs || die
has_prog ssh || die
has_prog cvs2cl.pl || die
cd $path || die

# check if this path is already in the repository
[ "`find -path "*CVS*"`" ] || ( cd .. && cvs -qz9 add `basename $path` )

# generate ChangeLog
cvs2cl.pl -g -qz9 -I ChangeLog
rm -f ChangeLog.bak

# compare local tree with CVS
find ! -path "*CVS*" ! -path "." | sort >$t/local
find -name Entries -path "*CVS*" -exec grep -H / {} \; \
| rev | cut -d / -f 5,8- | rev | sort >$t/cvs

# remove entries that are not here anymore
fgrep -vxf $t/local $t/cvs | xargs -rl cvs -qz9 rm

# add entries that are new here
fgrep -vxf $t/cvs $t/local | xargs -rl cvs -qz9 add
cvs -qz9 ci -m "$export_opt"
