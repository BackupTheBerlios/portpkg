#!/bin/sh
# sync-slack - portpkg-addon for using slackware source as ports

#include "portpkg.h"
source `which portpkg` || exit 1

RSYNC=rsync://rsync.slackware.at/slackware/slackware-current/source
DIST=ftp://ftp.slackware.com/pub/slackware/slackware-current
TREE=/usr/ports/z/slack

stanza "pp-sync-slack -- A portpkg-addon that imports Slackware's source to the ports
tree. Since this script is kind of hack-around (a work-around-hack) it's not
that easy to use.

pp-sync-slack will rsync a smaller part of Slackware's source and add it to the
ports tree in $TREE. You will be able to compile imported ports (that are
supported :). Currently, it imports about 90 % of Slackware's packages, which
might be a ventured assumption. But, you can use them as templates for your
ports of course.

If this is the first time you use pp-sync-slack, you will be asked for a target
distribution version. Choose '10.0' or maybe 'current', but only if you use
Slackware-current! You can change this later in $PRT_DIR/local.conf.

Have fun."

echo -ne "\nContinue (ctrl-c to abort) "
read me

is_root || die
mkdir -p $TREE
cd $TREE || die
has_pkg rsync-2.6 || die
# sync source/ and remove files we don't need
rsync -avz --delete \
--exclude "FILE_LIST" \
--exclude "MANIFEST.*" \
--exclude "CHECKSUMS*" \
--exclude "README.TXT" \
--exclude "*.tar.gz" \
--exclude "*.tar.bz2" \
--exclude "*.tgz" \
--exclude "*.tar.Z" \
--exclude "*.bin" \
--exclude "*.zip" \
$RSYNC/* .

# write missing files into sources-files
stanza "Building sources-files..."
t=`private`
row "Retrieving file list"
get $DIST/FILELIST.TXT $t.file_list
row "Constructing `find $TREE/ -name "*SlackBuild" | wc -l` (clean SlackBuild-) ports"
# for any file
grep -o "\./source/.*/.*/.*" $t.file_list \
| cut -d " " -f 1 | cut -d / -f 3- | while read s; do
    # if not found, add it to "sources"
    if ! find $s >/dev/null 2>&1; then
#	echo `echo $s | cut -d / -f 3-`
#    else
	echo $DIST/source/$s
    fi | grep -ve "SlackBuild$" -e "^slack-desc$" -e "^doinst.sh" \
    >>`echo $s | cut -d / -f 1-2`/sources
done

row "Constructing `find $TREE/ -name "*.build" | wc -l` .build-wrapper-ports"
find -name "*.build" | while read s; do
    dir=`dirname $s`
    gname=`dirname $s | cut -c 3-`
    group=`echo $gname | cut -d / -f 1`
    name=`echo $gname | cut -d / -f 2`
    ver=`grep ^VERSION= $s | cut -d = -f 2-`
    arch=`grep ^ARCH= $s | cut -d = -f 2- | sed -re "s,\\\\$\\{[A-Z]*:-,," -e "s,},,"`
    build=1slack
    cat <<EOF >$dir/SlackBuild
NAME=$name
VERSION=$ver
ARCH=$arch
BUILD=$build

checkinstall -S -y \\
  --pkgname=\$NAME \\
  --pkgversion=\$VERSION \\
  --pkgarch=\$ARCH \\
  --pkgrelease=\$BUILD \\
  --pakdir=/tmp \\
  --strip=yes \\
  --stripso=yes \\
  --gzman=yes \\
  --backup=no \\
  "sh `basename $s`" || exit 1
EOF
done

stanza "Imported `find $TREE/ -name "*SlackBuild" | wc -l` ports of \
`find $TREE/ -type d -mindepth 2 -maxdepth 2 | wc -l` possible directories \
into $TREE."
