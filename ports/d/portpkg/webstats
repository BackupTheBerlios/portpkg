#!/bin/bash
# Update portpkg.berlios.de stats (DEVELOPERS ONLY)
# Needs CVS/shell access on berlios.de
#
# DO THIS FROM A CLEAN CVS TREE, NOT FROM YOUR WORKING PORTS TREE

. `which portpkg` || exit 1

viewcvs=http://cvs.berlios.de/cgi-bin/viewcvs.cgi/portpkg/ports
shell=shell.berlios.de
htdocs=/home/groups/portpkg/htdocs
login=`cat $PRT_DIR/CVS/Root | cut -d @ -f 1`
t=`mktemp -d`

cd $PRT_DIR/d/portpkg || die

pause "Continue updating web stats according to $PRT_DIR/ChangeLog?"

row "Recent changes"
{ echo "<dl>"
  cat $PRT_DIR/ChangeLog \
| grep -oe "^[0-9][^ ]*" -e "[^ ]*[./]*SlackBuild[,:]" \
| sed "s,[./]SlackBuild.,," \
| head -n 40 \
| ( d=""
    while read s; do
      case $s in
        [0-9]*[0-9])
          d="$s";;
        *)
          [ "$d" ] && echo "<dt>$d</dt>"
          d=""
          ls_loc `regex $s` | grep -ve local/ -e z/ | loc2gpkg \
| sed "s,-$ARCH-,-i486-,;s,\(.*\)-\([^-]*-[^-]*-[^-]*\)$,<a href=\"$viewcvs/\1\">\1</a> \2<br>,"
      esac
    done )
  echo "</dl>"
} >$t/ports.recent
#} >ports.recent

row "Ports count"
#find $PRT_DIR/ -name "Entries" -exec grep SlackBuild {} \; | wc -l >ports.amount
find $PRT_DIR/ -name "Entries" -exec grep SlackBuild {} \; | wc -l >$t/ports.amount

row "Complete list"
cd $PRT_DIR
find * -name "Entries" -exec grep -H SlackBuild {} \; \
| sed "s,/CVS/Entries:,,;s,SlackBuild.*,SlackBuild," \
| while read s; do
  p=`echo $s | slk2loc`
  n=`echo $p | pkg2name | any2base`
  d=`grep -m1 -sh "^$n:" $s $(echo $s | sed "s,SlackBuild,slack-desc,")`
  echo "$p|$d"
done | column -t -s \| >$t/ports.complete

row "Committing changes"
#cvs ci -m "Updated." ports.recent ports.amount
scp $t/ports.* $login@$shell:$htdocs/
