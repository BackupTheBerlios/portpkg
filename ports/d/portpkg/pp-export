#!/bin/sh
# export - A portpkg-addon to pack one's ports to a tarball

source `which portpkg` || exit 1

stanza "pp-export -- A portpkg-addon that packs your ports to a tarball for
submission to the Portpkg Project hosted on http://portpkg.berlios.de."

#usage
if [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
  die "Usage: pp-export [port ..]"
fi

[ "$MY_TAG" ] || die "No tag set. Please run 'pp-config'!"
[ "$MY_EMAIL" ] || die "No mail address set. Please run 'pp-config'!"
[ "$MY_REALNAME" ] || die "No real name set. Please run 'pp-config'!"

echo -ne "\nContinue exporting ports with tag '$MY_TAG'? (ctrl-c to quit) "
read

cd $PRT_DIR || die

# find ports
stanza "Finding ports:"
temp=/tmp/ports-$MY_TAG
ports=`find $@ -name "*SlackBuild" -follow | grep -v "^./SlackBuild$" \
| xargs grep -l "^BUILD=[0-9]*$MY_TAG$" | grep -v /open/ \
| rev | cut -d / -f 2- | rev`
if ! [ "$ports"  ]; then
    row "Cannot find any ports from you!"
    exit 1
fi
echo "$ports" | xargs -l echo "  --> Found"
count=`echo "$ports" | wc -l`

# create tarball
stanza "Creating tarball:"
row "Copying $count ports to $temp/"
rm -rf $temp || exit 1
mkdir $temp
cp -a --parents $ports $temp

priv="arbitrary CVS"
#row "Removing private files from export: $priv"
for i in $priv; do
    find $temp -name "$i" -exec rm -rf {} \; 2>/dev/null
done

row "Writing info-file (contains $MY_TAG, $MY_EMAIL, $MY_REALNAME)"
echo "tag: $MY_TAG" >$temp/info
echo "email: $MY_EMAIL" >>$temp/info
echo "realname: $MY_REALNAME" >>$temp/info

timestamp=`date +%Y%m%d`
row "Creating ports-$MY_TAG-$timestamp.tar.bz2"
(   cd `dirname $temp`
    tar cjf ports-$MY_TAG-$timestamp.tar.bz2 `basename $temp`
)
mv /tmp/ports-$MY_TAG-$timestamp.tar.bz2 .

row "Removing $temp"
rm -r $temp
stanza "Tarball is in $PRT_DIR/ports-$MY_TAG-$timestamp.tar.bz2."
