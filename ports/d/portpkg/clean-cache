#!/bin/bash -u
# clean-cache - portpkg-addon that moves all outdated packages to outdated/

#include "portpkg.h"
source `which portpkg` || exit 1

t=`private`
stanza "Cleaning $PKG_DIR/:"
mkdir -p $PKG_DIR
cd $PKG_DIR/ || die
ls_avail >$t.avail
# leave local/ as is
ls_cache | grep -v "^local/" >$t.cache
row "Checking cache structure"
for gpkg in `fgrep -vxf $t.avail $t.cache`; do
    group=`grep -m 1 /$(echo $gpkg | cut -d / -f 2)$ $t.avail | cut -d / -f 1`
    group=${group:-outdated}
    case $gpkg in $group/*) continue;; esac
    row "Moving $gpkg to $group/"
    mkdir -p $group
    mv $gpkg.tgz $group/
done
find -type d -empty | while read pkg; do
    row "Deleting empty directory $pkg"
    rmdir $pkg
done
