#!/bin/sh

source `which portpkg` || exit 1
t=`mktemp -d`
is_root || die
back="Pp-config -- Setup for Portpkg"

dialog --backtitle "$back" --title "DISTRIBUTION VERSION" \
--inputbox "What distribution target do you focus? \
Possible answers are '10.0' or 'current'. If unsure enter '10.0'." 0 0 \
"$DIST_VER" 2>$t/dist-ver || exit
DIST_VER=`cat $t/dist-ver`
sed -i "/^DIST_VER=/d" $PRT_DIR/local.conf
if [ "$DIST_VER" ]; then
  echo "DIST_VER=\"$DIST_VER\"" >>$PRT_DIR/local.conf
  if [ $DIST_VER == current ]; then
    if dialog --backtitle "$back" --title "EXCLUDE PASTURE/" \
--yesno "You are using 'current'. It is recommended to exclude ports of the \
group pasture/. Shall I add 'pasture/' to your exclude list \
($PRT_DIR/exclude.local)?" 0 0; then
      # add pasture/ to the list of excluded ports
      sed -i "/^pasture\/$/d" $PRT_DIR/exclude.local
      echo "pasture/" >>$PRT_DIR/exclude.local
    fi
  fi
fi

dialog --backtitle "$back" --title "YOUR TAG" \
--inputbox "If you plan to write ports, what tag would you like to use? Only \
lower case letters allowed (e.g. 'mich'). Leave this empty if unsure or you \
don't plan to write ports." 0 0 "$MY_TAG" 2>$t/my-tag || exit
MY_TAG=`cat $t/my-tag | tr "A-Z" "a-z" | sed "s,[^a-z],,g"`
sed -i "/^MY_TAG=/d" $PRT_DIR/local.conf
sed -i "/^MY_EMAIL=/d" $PRT_DIR/local.conf
sed -i "/^MY_REALNAME=/d" $PRT_DIR/local.conf
if [ "$MY_TAG" ]; then
  echo "MY_TAG=\"$MY_TAG\"" >>$PRT_DIR/local.conf
  dialog --backtitle "$back" --title "YOUR MAIL ADDRESS" \
  --inputbox "If you plan to contrib your ports to the Portpkg Project, you \
need to enter your mail address. Leave this empty if you don't plan to \
contribute ports." 0 0 "$MY_EMAIL" 2>$t/my-email || exit
  MY_EMAIL=`cat $t/my-email`
  if [ "$MY_EMAIL" ]; then
    echo "MY_EMAIL=\"$MY_EMAIL\"" >>$PRT_DIR/local.conf
    dialog --backtitle "$back" --title "YOUR REAL NAME" \
    --inputbox "Please enter your real name." 0 0 "$MY_REALNAME" \
    2>$t/my-realname || exit
    MY_REALNAME=`cat $t/my-realname`
    echo "MY_REALNAME=\"$MY_REALNAME\"" >>$PRT_DIR/local.conf
  fi
fi

sed -i "/^VERBOSE=/d" $PRT_DIR/local.conf
if dialog --backtitle "$back" --title "VERBOSE MODE" --defaultno \
--yesno "Do you want to have always verbose mode? You will see more output. If \
unsure answer 'no'." 0 0; then
  echo "VERBOSE=true" >>$PRT_DIR/local.conf
fi

sed -i "/^NO_REQS=/d" $PRT_DIR/local.conf
sed -i "/^LAZY_CHECKS=/d" $PRT_DIR/local.conf
if dialog --backtitle "$back" --title "DEPENDENCY RESOLUTION" \
--yesno "Do you want to have dependency resolution always enabled? If unsure \
answer 'yes'." 0 0; then
  if dialog --backtitle "$back" --title "LAZY UPGRADING" --defaultno \
  --yesno "Do you want to have lazy upgrading always enabled? Dependencies will \
  normally being upgraded if possible. Lazy upgrading cuts that off. If unsure \
  answer 'no'." 0 0; then
    echo "LAZY_CHECKS=true" >>$PRT_DIR/local.conf
  fi
else
  echo "NO_REQS=true" >>$PRT_DIR/local.conf
fi
